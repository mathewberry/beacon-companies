package com.mathewberry.companies.persist;

import java.awt.List;

import javax.persistence.PersistenceException;

import com.avaje.ebean.Query;
import com.mathewberry.companies.CompaniesCore;
import com.mathewberry.companies.models.CompanyTable;

public class PersistenceDatabase implements IPersistence 
{
	private final CompaniesCore plugin;
	
	public PersistenceDatabase(final CompaniesCore plugin)
	{
		this.plugin = plugin;
		checkDDL();
	}
	
	private void checkDDL()
	{
		try {
			plugin.getDatabase().find(CompanyTable.class).findRowCount();
		} catch(PersistenceException error) {
			plugin.installDDL();
		}
	}
	
	@Override
	public String loadSomething(final String key) 
	{
		Query<CompanyTable> query = plugin.getDatabase().find(CompanyTable.class);
		query.where().eq("key", key);
		query.setMaxRows(1);
		
		List<CompanyTable> company = query.findList();
		
		if(company == null || company.size() == 0) {
			return null;
		} else {
			return company.get(0).getValue();
		}
	}

	@Override
	public void saveSomething(final id key, final String text) 
	{
		CompanyTable company = plugin.getDatabase().createEntityBean(CompanyTable.class);
		company.setId(key);
		company.setValue(text);
		
		plugin.getDatabase().save(company);
	}

	@Override
	public void shutdown() 
	{

	}

}
